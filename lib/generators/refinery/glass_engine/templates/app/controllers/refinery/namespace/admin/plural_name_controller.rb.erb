module Refinery
  module <%= namespacing %>
    module Admin
      class <%= class_name.pluralize %>Controller < ::Refinery::AdminController

        crudify :'refinery/<%= namespacing.underscore %>/<%= singular_name %>'<% if (title = attributes.detect { |a| a.type.to_s =~ /string|text/ }).present? and title.name != 'title' -%>,
                :title_attribute => '<%= title.name %>'<% end -%><% if plural_name == singular_name -%>,
                :redirect_to_url => :refinery_<%= namespacing.underscore %>_admin_<%= singular_name %>_index_path<% end %>,
                :searchable => false,
                :xhr_paging => true

        before_filter :set_image, :only => [:edit, :new, :create, :update]

          # NOTE: making searchable: remember to add to your model `acts_as_indexed :fields => [:title, :body]`

        private
          def set_image
            image_attributes = []

            if @<%= singular_name.underscore %>.present?
              @<%= singular_name.underscore %>.attributes.each_with_index do |attribute, index|
                if attribute.type.to_s == 'image'
                  image_attributes.push(attribute.name)
                end
              end
            end

            @image = (@<%= singular_name.underscore %>.present? && @<%= singular_name.underscore %>[image_attributes.first.to_sym].present?) ?
              @<%= singular_name.underscore -%>[image_attributes.first.to_sym]
              : Refinery::Image.new
          end
      end
    end
  end
end
